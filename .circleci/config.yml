version: 2
jobs:
  test:
    working_directory: ~/repo
    docker:
      - image: karrot/python:1.2
        environment:
          PGHOST: 127.0.0.1
      - image: circleci/postgres:9.6.2
        environment:
          POSTGRES_USER: ubuntu
          POSTGRES_DB: fstool_e2etest
      - image: redis:3.2.11
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          key: python-cache
      - run:
          command: |
            export LC_ALL=C.UTF-8
            export LANG=C.UTF-8
            virtualenv -p python3 env
            env/bin/pip install --upgrade pip
            env/bin/pip install pip-tools
            env/bin/pip-sync requirements*.txt
            cp config/local_settings.py.ci config/local_settings.py
            env/bin/coverage run manage.py test --parallel 4
            env/bin/flake8 ./
            env/bin/coverage html -d coverage-report
            env/bin/pip install codecov && env/bin/codecov
      - save_cache:
          paths:
            - env
            - ~/.cache/pip
          key: python-cache
      - store_artifacts:
          path: coverage-report

workflows:
  version: 2
  all-the-things:
    jobs:
      - test
